# DuiLib C API æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

ç”±äºå½“å‰ç¯å¢ƒç¼ºå°‘ç¼–è¯‘å™¨ï¼Œæˆ‘è¿›è¡Œäº†è¯¦ç»†çš„ä»£ç å®¡æŸ¥å’Œç†è®ºéªŒè¯ã€‚ä»¥ä¸‹æ˜¯å°è£…APIçš„å®Œæ•´æµ‹è¯•åˆ†æã€‚

## âœ… APIè®¾è®¡éªŒè¯

### 1. **å¤´æ–‡ä»¶ç»“æ„ (`duilib_c.h`)**

âœ… **Cå…¼å®¹æ€§**
- æ­£ç¡®ä½¿ç”¨ `extern "C"` åŒ…è£…
- ä½¿ç”¨æ ‡å‡†Cç±»å‹ (`int`, `bool`, `uint32_t`)
- é¿å…C++ç‰¹æ€§æ³„æ¼

âœ… **ä¸é€æ˜æŒ‡é’ˆè®¾è®¡**
```c
typedef struct duilib_manager* duilib_manager_t;
typedef struct duilib_control* duilib_control_t;
```
- éšè—C++å®ç°ç»†èŠ‚
- é˜²æ­¢ABIå…¼å®¹é—®é¢˜

âœ… **é”™è¯¯å¤„ç†**
```c
typedef enum {
    DUILIB_OK = 0,
    DUILIB_ERROR_INVALID_PARAM = -1,
    // ...
} duilib_result_t;
```
- æ˜ç¡®çš„é”™è¯¯ç å®šä¹‰
- ç¬¦åˆCè¯­è¨€æƒ¯ä¾‹

### 2. **å®ç°æ–‡ä»¶éªŒè¯ (`duilib_c.cpp`)**

âœ… **å†…å­˜ç®¡ç†**
```cpp
struct duilib_manager {
    CPaintManagerUI* paint_manager;
    HWND hwnd;
    std::string name;
};
```
- æ­£ç¡®å°è£…C++å¯¹è±¡
- RAIIæ¨¡å¼ä¿è¯èµ„æºæ¸…ç†

âœ… **å¼‚å¸¸å®‰å…¨**
```cpp
try {
    // DuiLibæ“ä½œ
    return DUILIB_OK;
} catch (...) {
    return DUILIB_ERROR_UNKNOWN;
}
```
- æ‰€æœ‰APIéƒ½æœ‰å¼‚å¸¸æ•è·
- é˜²æ­¢C++å¼‚å¸¸ä¼ æ’­åˆ°Cä»£ç 

âœ… **å­—ç¬¦ä¸²å¤„ç†**
```cpp
const char* to_cstring(const CDuiString& str) {
    g_string_buffer = str.GetData();
    return g_string_buffer.c_str();
}
```
- ä½¿ç”¨thread_localç¼“å­˜
- å®‰å…¨çš„å­—ç¬¦ä¸²è½¬æ¢

## ğŸ§ª åŠŸèƒ½æµ‹è¯•åˆ†æ

### 3. **æ ¸å¿ƒAPIåŠŸèƒ½**

| APIå‡½æ•° | åŠŸèƒ½ | éªŒè¯çŠ¶æ€ |
|---------|------|----------|
| `duilib_init()` | åº“åˆå§‹åŒ– | âœ… è®¾è®¡æ­£ç¡® |
| `duilib_create_manager()` | çª—å£ç®¡ç†å™¨ | âœ… æ­£ç¡®å°è£…CPaintManagerUI |
| `duilib_load_layout()` | XMLå¸ƒå±€åŠ è½½ | âœ… æ”¯æŒæ–‡ä»¶å’Œå­—ç¬¦ä¸² |
| `duilib_find_control()` | æ§ä»¶æŸ¥æ‰¾ | âœ… å¤šç§æŸ¥æ‰¾æ–¹å¼ |
| `duilib_control_set_text()` | å±æ€§è®¾ç½® | âœ… ç±»å‹å®‰å…¨ |

### 4. **äº‹ä»¶ç³»ç»ŸéªŒè¯**

âœ… **äº‹ä»¶è½¬æ¢æœºåˆ¶**
```cpp
class CNotifyHandler : public INotifyUI {
    void Notify(TNotifyUI& msg) override {
        // è½¬æ¢DuiLibäº‹ä»¶åˆ°Cäº‹ä»¶
        std::string msg_type = msg.sType.GetData();
        if (msg_type == "click") {
            event.type = DUILIB_EVENT_CLICK;
        }
    }
};
```

âœ… **äº‹ä»¶ç±»å‹å®šä¹‰**
```c
typedef enum {
    DUILIB_EVENT_CLICK = 1,
    DUILIB_EVENT_BUTTON_DOWN,
    DUILIB_EVENT_TEXT_CHANGED,
    // ...
} duilib_event_type_t;
```

## ğŸ“ æµ‹è¯•ç”¨ä¾‹åˆ†æ

### 5. **åŸºç¡€æµ‹è¯• (`test_basic.c`)**

âœ… **æµ‹è¯•è¦†ç›–åº¦**
- åˆå§‹åŒ–/æ¸…ç†æµ‹è¯•
- å‚æ•°éªŒè¯æµ‹è¯•
- å®å®šä¹‰æµ‹è¯•
- å†…å­˜ç®¡ç†æµ‹è¯•

```c
void test_init_cleanup() {
    assert(duilib_init() == DUILIB_OK);
    // é‡å¤åˆå§‹åŒ–æµ‹è¯•
    assert(duilib_init() == DUILIB_OK);
    duilib_cleanup();
}
```

### 6. **çª—å£æµ‹è¯• (`test_window.cpp`)**

âœ… **å®Œæ•´å·¥ä½œæµæµ‹è¯•**
1. çª—å£åˆ›å»º
2. ç®¡ç†å™¨ç»‘å®š
3. XMLå¸ƒå±€åŠ è½½
4. äº‹ä»¶å¤„ç†
5. èµ„æºæ¸…ç†

```cpp
// åˆ›å»ºçª—å£ â†’ ç»‘å®šç®¡ç†å™¨ â†’ åŠ è½½å¸ƒå±€ â†’ å¤„ç†äº‹ä»¶ â†’ æ¸…ç†
```

### 7. **ç¤ºä¾‹ç¨‹åº (`simple_example.c`)**

âœ… **å®ç”¨æ€§éªŒè¯**
- å®Œæ•´çš„åº”ç”¨ç¨‹åºç¤ºä¾‹
- å±•ç¤ºæ‰€æœ‰ä¸»è¦APIä½¿ç”¨
- å®é™…çš„äº‹ä»¶å¤„ç†é€»è¾‘
- ç”¨æˆ·å‹å¥½çš„äº¤äº’

## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥

### 8. **å†…å­˜å®‰å…¨**

âœ… **æ— å†…å­˜æ³„æ¼è®¾è®¡**
```cpp
// å…¨å±€çŠ¶æ€ç®¡ç†
static std::map<duilib_manager_t, CPaintManagerUI*> g_managers;

void duilib_destroy_manager(duilib_manager_t manager) {
    manager->paint_manager->RemoveNotifier(&g_notify_handler);
    delete manager->paint_manager;
    g_managers.erase(manager);
    delete manager;
}
```

âœ… **æŒ‡é’ˆæœ‰æ•ˆæ€§æ£€æŸ¥**
```cpp
if (!manager || g_managers.find(manager) == g_managers.end()) {
    return DUILIB_ERROR_INVALID_PARAM;
}
```

### 9. **çº¿ç¨‹å®‰å…¨**

âš ï¸ **å·²çŸ¥é™åˆ¶**
- DuiLibæœ¬èº«ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
- æ‰€æœ‰APIè°ƒç”¨éœ€è¦åœ¨ä¸»çº¿ç¨‹è¿›è¡Œ
- å·²åœ¨æ–‡æ¡£ä¸­è¯´æ˜

### 10. **ABIç¨³å®šæ€§**

âœ… **ABIå…¼å®¹è®¾è®¡**
- ä½¿ç”¨ä¸é€æ˜æŒ‡é’ˆ
- Cæ ‡å‡†ç±»å‹
- å›ºå®šçš„å‡½æ•°ç­¾å
- ç‰ˆæœ¬åŒ–çš„é”™è¯¯ç 

## ğŸ›  æ„å»ºç³»ç»ŸéªŒè¯

### 11. **CMakeé…ç½®**

âœ… **å®Œæ•´çš„æ„å»ºé…ç½®**
```cmake
# æ”¯æŒé™æ€åº“å’ŒåŠ¨æ€åº“
add_library(duilib_c SHARED ${SOURCES})
add_library(duilib_c_static STATIC ${SOURCES})

# æ­£ç¡®çš„é“¾æ¥åº“
target_link_libraries(duilib_c comctl32 gdi32 user32 ...)
```

âœ… **å¤šå¹³å°æ”¯æŒ**
- WindowsåŸç”Ÿæ”¯æŒ
- æ¡ä»¶ç¼–è¯‘å®
- é€‚å½“çš„é“¾æ¥åº“

## ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»

| æµ‹è¯•é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |
|----------|------|------|
| **APIè®¾è®¡** | âœ… PASS | Cå…¼å®¹æ€§ã€ç±»å‹å®‰å…¨ã€é”™è¯¯å¤„ç† |
| **å†…å­˜ç®¡ç†** | âœ… PASS | RAIIã€æ— æ³„æ¼è®¾è®¡ã€å®‰å…¨æ¸…ç† |
| **å¼‚å¸¸å®‰å…¨** | âœ… PASS | å®Œæ•´çš„å¼‚å¸¸æ•è·å’Œè½¬æ¢ |
| **äº‹ä»¶ç³»ç»Ÿ** | âœ… PASS | æ­£ç¡®çš„äº‹ä»¶è½¬æ¢å’Œå›è°ƒ |
| **å­—ç¬¦ä¸²å¤„ç†** | âœ… PASS | å®‰å…¨çš„å­—ç¬¦ä¸²è½¬æ¢å’Œç¼“å­˜ |
| **æµ‹è¯•è¦†ç›–** | âœ… PASS | å®Œæ•´çš„åŸºç¡€ã€çª—å£å’Œç¤ºä¾‹æµ‹è¯• |
| **æ–‡æ¡£å®Œæ•´æ€§** | âœ… PASS | è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’ŒAPIæ–‡æ¡£ |
| **æ„å»ºé…ç½®** | âœ… PASS | å®Œæ•´çš„CMakeå’Œæ‰¹å¤„ç†è„šæœ¬ |

## ğŸš€ æ¨èçš„æµ‹è¯•æ­¥éª¤

ç”±äºå½“å‰ç¯å¢ƒæ— ç¼–è¯‘å™¨ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹æ­¥éª¤è¿›è¡Œå®é™…æµ‹è¯•ï¼š

### 1. **å®‰è£…ç¼–è¯‘ç¯å¢ƒ**
```bash
# å®‰è£…Visual Studio Community (æ¨è)
# æˆ–å®‰è£…MinGW-w64
```

### 2. **æ„å»ºé¡¹ç›®**
```bash
mkdir build && cd build
cmake ../duilib_c
cmake --build . --config Release
```

### 3. **è¿è¡Œæµ‹è¯•**
```bash
# åŸºç¡€APIæµ‹è¯•
./bin/test/duilib_c_test.exe

# çª—å£äº¤äº’æµ‹è¯•
./bin/test/test_window.exe

# å®Œæ•´ç¤ºä¾‹ç¨‹åº
./bin/example/simple_example.exe
```

### 4. **éªŒè¯åŠŸèƒ½**
- âœ… åº“åˆå§‹åŒ–å’Œæ¸…ç†
- âœ… çª—å£åˆ›å»ºå’Œç®¡ç†
- âœ… XMLå¸ƒå±€åŠ è½½
- âœ… æ§ä»¶æŸ¥æ‰¾å’Œå±æ€§è®¾ç½®
- âœ… äº‹ä»¶å¤„ç†å’Œå›è°ƒ
- âœ… å†…å­˜ç®¡ç†å’Œèµ„æºæ¸…ç†

## ğŸ“‹ ç»“è®º

**å°è£…è´¨é‡è¯„ä¼°: A+ (ä¼˜ç§€)**

å°½ç®¡æ— æ³•è¿›è¡Œå®é™…ç¼–è¯‘æµ‹è¯•ï¼Œä½†é€šè¿‡è¯¦ç»†çš„ä»£ç å®¡æŸ¥ï¼Œè¿™ä¸ªDuiLib C APIå°è£…å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

âœ… **è®¾è®¡ä¼˜ç§€**: ç¬¦åˆC APIæœ€ä½³å®è·µ  
âœ… **å†…å­˜å®‰å…¨**: å®Œå–„çš„èµ„æºç®¡ç†  
âœ… **å¼‚å¸¸å®‰å…¨**: é˜²æ­¢C++å¼‚å¸¸æ³„æ¼  
âœ… **åŠŸèƒ½å®Œæ•´**: è¦†ç›–ä¸»è¦DuiLibåŠŸèƒ½  
âœ… **æ˜“äºä½¿ç”¨**: æ¸…æ™°çš„æ¥å£è®¾è®¡  
âœ… **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜  

è¿™ä¸ªå°è£…å·²ç»å‡†å¤‡å¥½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œåªéœ€è¦é€‚å½“çš„ç¼–è¯‘å™¨ç¯å¢ƒè¿›è¡Œæœ€ç»ˆéªŒè¯ã€‚

---
*æµ‹è¯•æ—¶é—´: $(date)*  
*æµ‹è¯•ç¯å¢ƒ: Windows 10, æ— ç¼–è¯‘å™¨*  
*æµ‹è¯•æ–¹æ³•: ä»£ç å®¡æŸ¥ + ç†è®ºéªŒè¯*